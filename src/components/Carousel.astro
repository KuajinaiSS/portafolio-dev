---
import { Image } from "astro:assets";

const { images = [], id = "default-carousel" } = Astro.props;

// Normalizar el formato de imágenes
const normalizedImages = images.map(item => {
    if (item && typeof item === "object" && "img" in item) {
        return item.img; // Formato { img: ..., id: ... }
    }
    return item;
});
---

<div class="carousel w-full" id={id}>
    {normalizedImages.map((img, i) => {
        const slideId = `${id}-slide${i + 1}`;
        const prevSlideId = i === 0 ? `${id}-slide${normalizedImages.length}` : `${id}-slide${i}`;
        const nextSlideId = i === normalizedImages.length - 1 ? `${id}-slide1` : `${id}-slide${i + 2}`;
        
        return (
            <div id={slideId} class="carousel-item relative w-full">
                <div class="w-full h-56 md:h-96 flex items-center justify-center bg-base-200">
                    <Image
                        src={img}
                        alt={`Imagen ${i + 1} del proyecto`}
                        class="max-w-full max-h-full object-contain"
                        loading={i === 0 ? "eager" : "lazy"}
                        decoding="async"
                        sizes="(max-width: 768px) 100vw, 800px"
                    />
                </div>
                <div class="absolute left-5 right-5 top-1/2 flex -translate-y-1/2 transform justify-between">
                    <a href={`#${prevSlideId}`} class="btn btn-circle bg-yellow-300/50 hover:bg-yellow-300 text-black" data-carousel-nav data-carousel-id={id} data-direction="prev">❮</a>
                    <a href={`#${nextSlideId}`} class="btn btn-circle bg-yellow-300/50 hover:bg-yellow-300 text-black" data-carousel-nav data-carousel-id={id} data-direction="next">❯</a>
                </div>
            </div>
        );
    })}
</div>

<script>
    function initCarousel(carouselId) {
        const carousel = document.getElementById(carouselId);
        if (!carousel) return;

        const navButtons = carousel.querySelectorAll(`a[data-carousel-nav][data-carousel-id="${carouselId}"]`);

        function scrollToSlide(slideId) {
            const slide = carousel.querySelector(`#${slideId}`);
            if (slide) {
                // Usar scrollIntoView con opciones para evitar scroll de página
                slide.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest',
                    inline: 'center'
                });
            }
        }

        // Agregar event listeners a los botones de navegación
        navButtons.forEach((button) => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const href = button.getAttribute('href');
                if (href && href.startsWith('#')) {
                    const slideId = href.substring(1);
                    scrollToSlide(slideId);
                }
            });
        });
    }

    // Inicializar todos los carruseles
    function initAllCarousels() {
        const carousels = document.querySelectorAll('[id^="carousel-"]');
        carousels.forEach(carousel => {
            initCarousel(carousel.id);
        });
    }

    // Inicializar cuando la página carga
    document.addEventListener('astro:page-load', initAllCarousels);
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAllCarousels);
    } else {
        initAllCarousels();
    }
</script>
