---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

interface Props {
    images?: (ImageMetadata | { img: ImageMetadata; id?: string })[];
    id?: string;
}

const { images = [], id = "default-carousel" } = Astro.props;

const normalizedImages = images.map((item: ImageMetadata | { img: ImageMetadata; id?: string }) => {
    if (item && typeof item === "object" && "img" in item) {
        return item.img;
    }
    return item as ImageMetadata;
});
---

<div class="carousel w-full" id={id}>
    {normalizedImages.map((img: ImageMetadata, i: number) => (
        <div class="carousel-item relative w-full">
            <div class="w-full h-56 md:h-96 flex items-center justify-center bg-base-200">
                <Image
                    src={img}
                    alt={`Imagen ${i + 1} del proyecto`}
                    class="max-w-full max-h-full object-contain"
                    loading={i === 0 ? "eager" : "lazy"}
                    decoding="async"
                    sizes="(max-width: 768px) 100vw, 800px"
                />
            </div>
            <div class="absolute left-5 right-5 top-1/2 flex -translate-y-1/2 transform justify-between">
                <button 
                    class="btn btn-circle bg-yellow-300/50 hover:bg-yellow-300 text-black carousel-btn"
                    data-slide-index={i === 0 ? normalizedImages.length - 1 : i - 1}
                    data-carousel={id}
                    type="button"
                >❮</button>
                <button 
                    class="btn btn-circle bg-yellow-300/50 hover:bg-yellow-300 text-black carousel-btn"
                    data-slide-index={i === normalizedImages.length - 1 ? 0 : i + 1}
                    data-carousel={id}
                    type="button"
                >❯</button>
            </div>
        </div>
    ))}
</div>

<script>
    function initCarousels() {
        const buttons = document.querySelectorAll('button.carousel-btn');
        
        buttons.forEach(button => {
            button.replaceWith(button.cloneNode(true));
        });
        
        document.querySelectorAll('button.carousel-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                
                const carouselId = button.getAttribute('data-carousel');
                const slideIndex = button.getAttribute('data-slide-index');
                
                if (!carouselId || !slideIndex) return;
                
                const targetIndex = parseInt(slideIndex);
                const carousel = document.getElementById(carouselId);
                
                if (carousel) {
                    const slides = carousel.querySelectorAll('.carousel-item');
                    const targetSlide = slides[targetIndex];
                    
                    if (targetSlide) {
                        targetSlide.scrollIntoView({ 
                            behavior: 'smooth',
                            block: 'nearest',
                            inline: 'center'
                        });
                    }
                }
            });
        });
    }
    
    document.addEventListener('astro:page-load', initCarousels);
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCarousels);
    } else {
        initCarousels();
    }
</script>