---
import { Image } from "astro:assets";

const { images = [], id = "default-carousel" } = Astro.props;

// Normalizar el formato de imágenes
const normalizedImages = images.map(item => {
    if (item && typeof item === "object" && "img" in item) {
        return item.img; // Formato { img: ..., id: ... }
    }
    return item;
});
---

<div id={id} class="relative w-full" data-carousel-manual>
    <!-- Carousel wrapper -->
    <div class="relative h-56 md:h-96 overflow-hidden rounded-lg bg-gray-800">
        {normalizedImages.map((img, i) => (
            <div
                class={`duration-700 ease-in-out ${i === 0 ? "" : "hidden"}`}
                data-carousel-item={i === 0 ? "active" : ""}
            >
                <Image
                    src={img}
                    alt={`slide-${i + 1}`}
                    class="absolute block w-full h-full object-contain object-center bg-gray-800"
                    loading={i === 0 ? "eager" : "lazy"}
                />
            </div>
        ))}
    </div>

    <!-- Slider indicators -->
    <div class="absolute z-30 flex -translate-x-1/2 bottom-5 left-1/2 space-x-3">
        {normalizedImages.map((_, i) => (
            <button
                type="button"
                class={`w-3 h-3 rounded-full border border-slate-900 transition
                        ${i === 0 
                            ? "bg-slate-900" 
                            : "bg-white hover:bg-slate-100"
                        }`}
                aria-label={`Slide ${i + 1}`}
                aria-current={i === 0 ? "true" : "false"}
                data-carousel-slide-to={i}
            ></button>
        ))}
    </div>

    <!-- Botón anterior -->
    <button 
        type="button"
        class="absolute top-0 start-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer"
        data-carousel-prev
    >
        <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-slate-900 hover:bg-slate-800 transition">
            <svg class="w-5 h-5 text-white rtl:rotate-180" aria-hidden="true" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="m15 19-7-7 7-7"/>
            </svg>
            <span class="sr-only">Previous</span>
        </span>
    </button>

    <!-- Botón siguiente -->
    <button 
        type="button"
        class="absolute top-0 end-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer"
        data-carousel-next
    >
        <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-slate-900 hover:bg-slate-800 transition">
            <svg class="w-5 h-5 text-white rtl:rotate-180" aria-hidden="true" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="m9 5 7 7-7 7"/>
            </svg>
            <span class="sr-only">Next</span>
        </span>
    </button>
</div>

<script>
    function initCarousel(root) {
        const items = root.querySelectorAll("[data-carousel-item]");
        const indicators = root.querySelectorAll("[data-carousel-slide-to]");
        const prevButton = root.querySelector("[data-carousel-prev]");
        const nextButton = root.querySelector("[data-carousel-next]");

        let currentIndex = 0;
        const totalItems = items.length;

        function updateCarousel(newIndex) {
            if (newIndex === currentIndex) return;

            // Ocultar actual
            items[currentIndex].classList.add("hidden");
            items[currentIndex].setAttribute("data-carousel-item", "");

            indicators[currentIndex].classList.remove("bg-slate-900");
            indicators[currentIndex].classList.add("bg-white");
            indicators[currentIndex].setAttribute("aria-current", "false");

            // Mostrar nuevo
            currentIndex = newIndex;

            items[currentIndex].classList.remove("hidden");
            items[currentIndex].setAttribute("data-carousel-item", "active");

            indicators[currentIndex].classList.remove("bg-white");
            indicators[currentIndex].classList.add("bg-slate-900");
            indicators[currentIndex].setAttribute("aria-current", "true");
        }

        // Flecha siguiente
        nextButton?.addEventListener("click", () => {
            const nextIndex = (currentIndex + 1) % totalItems;
            updateCarousel(nextIndex);
        });

        // Flecha anterior
        prevButton?.addEventListener("click", () => {
            const prevIndex = (currentIndex - 1 + totalItems) % totalItems;
            updateCarousel(prevIndex);
        });

        // Click en bolitas
        indicators.forEach((indicator, index) => {
            indicator.addEventListener("click", () => {
                updateCarousel(index);
            });
        });
    }

    function initAllCarousels() {
        const carousels = document.querySelectorAll("[data-carousel-manual]");
        carousels.forEach(root => initCarousel(root));
    }

    document.addEventListener("astro:page-load", initAllCarousels);

    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initAllCarousels);
    } else {
        initAllCarousels();
    }
</script>